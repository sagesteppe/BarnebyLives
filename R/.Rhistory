.before = geometry)
View(sites)
sites_in <- data.frame(
longitude_dd = runif(15, min = -120, max = -100),
latitude_dd = runif(15, min = 35, max = 48)
) |>
sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
distaze_results <- site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata') # takes some time
distaze_results <- site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata') # takes some time
sites_in <- data.frame(
longitude_dd = runif(15, min = -120, max = -100),
latitude_dd = runif(15, min = 35, max = 48)
) |>
sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(sites_in, gnis_places)
nf <- sf::st_nearest_feature(sites_in, gnis_places)
sites <- sites |> # sites to
dplyr::mutate(sf::st_drop_geometry(gnis_places[nf, 'ID']),
.before = geometry)
sites <- sites_in |> # sites to
dplyr::mutate(sf::st_drop_geometry(gnis_places[nf, 'ID']),
.before = geometry)
View(sites)
View(sites)
sites_in <- data.frame(
longitude_dd = runif(15, min = -120, max = -100),
latitude_dd = runif(15, min = 35, max = 48)
) |>
sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
View(sites_in)
set.seed(28)
sites_in <- data.frame(
longitude_dd = runif(15, min = -120, max = -100),
latitude_dd = runif(15, min = 35, max = 48)
) |>
sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
nf <- sf::st_nearest_feature(sites_in, gnis_places)
View(sites)
View(gnis_places)
sites <- sites_in |> # sites to
dplyr::mutate(sf::st_drop_geometry(gnis_places[nf,]),
.before = geometry)
View(sites)
View(sites)
View(sites_in)
View(sites_in)
??st_azimuth
??bearing
nngeo::st_azimuth(sites, sites_in)
sites <- sites_in |> # sites to
dplyr::mutate(sf::st_drop_geometry(gnis_places[nf,]),
.before = geometry) |>
sf::st_transform(5070)
sites <- dplyr::mutate(sf::st_drop_geometry(gnis_places[nf,]),
.before = geometry) |>
sf::st_transform(5070)
View(gnis_places)
View(sites)
sites <- dplyr::mutate(sf::st_drop_geometry(gnis_places[nf,]),
.before = geometry) #|>
sites <- gnis_places[nf,] |>
sf::st_transform(5070)
View(sites)
sites_in <- sf::st_transform(sites_in, 5070)
View(sites_in)
nngeo::st_azimuth(sites, sites_in)
round(nngeo::st_azimuth(sites, sites_in), 0)
sf::st_distance(sites, sites_in)
?st_distance
sf::st_distance(sites, sites_in, by_element = T)
sf::st_distance(sites, sites_in, by_element = T) / 1609.34
round( sf::st_distance(sites, sites_in, by_element = T) / 1609.34, -1)
round( sf::st_distance(sites, sites_in, by_element = T) / 1609.34, 2)
round( sf::st_distance(sites, sites_in, by_element = T) / 1609.34, 1)
round( sf::st_distance(sites, sites_in, by_element = T, 'Euclidean') / 1609.34, 1)
as.numeric(
round( sf::st_distance(sites, sites_in, by_element = T, 'Euclidean') / 1609.34, 1))
as.numeric(
round(
sf::st_distance(sites, sites_in, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
as.numeric(
round(
sf::st_distance(sites, sites_in, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
azimuth <- round(nngeo::st_azimuth(sites, sites_in), 0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, sites_in, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
?st_azimuth
sites
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,] |>
sf::st_transform(5070)
sites_in <- sf::st_transform(sites_in, 5070)
azimuth <- round(nngeo::st_azimuth(sites, sites_in), 0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, sites_in, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
place <- data.frame('Place' =
sf::st_drop_geometry(gnis_places[nf, 'fetr_nm']))
distances_df <- data.frame(
Distance = distance_miles,
Azimuth = azimuth,
Place = place
)  |>
dplyr::mutate(Site = if_else(
Distance < 100, paste0(fetr_nm, '.'),
paste0(Distance, 'mi', ' at ', format_degree(Azimuth), ' from ', fetr_nm, '.')),
Site = stringr::str_replace(Site, '\\..$', '.')) |>
dplyr::select(-any_of(c('Distance', 'Azimuth', 'Place', 'ID', 'fetr_nm')))
distances_df <-  dplyr::bind_cols(x, distances_df) |>
dplyr::relocate(any_of(c('Site', 'Allotment')), .before = geometry) |>
dplyr::select(-any_of(c('ID')))
return(distances_df)
}
site_writer(sites, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
st_crs(gnis_places)
sf::st_crs(gnis_places)
site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
sf::st_crs(sites_in)
sites_in <- data.frame(
longitude_dd = runif(15, min = -120, max = -100),
latitude_dd = runif(15, min = 35, max = 48)
) |>
sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
View(sites_in)
sites_in <- data.frame(
longitude_dd = runif(5, min = -120, max = -100),
latitude_dd = runif(5, min = 35, max = 48)
) |>
sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
View(site_writer)
site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,] |>
sf::st_transform(5070)
sites_in <- sf::st_transform(x, 5070)
azimuth <- round(nngeo::st_azimuth(sites, sites_in), 0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, sites_in, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
place <- data.frame('Place' =
sf::st_drop_geometry(gnis_places[nf, 'fetr_nm']))
distances_df <- data.frame(
Distance = distance_miles,
Azimuth = azimuth,
Place = place
)  |>
dplyr::mutate(Site = if_else(
Distance < 100, paste0(fetr_nm, '.'),
paste0(Distance, 'mi', ' at ', format_degree(Azimuth), ' from ', fetr_nm, '.')),
Site = stringr::str_replace(Site, '\\..$', '.')) |>
dplyr::select(-any_of(c('Distance', 'Azimuth', 'Place', 'ID', 'fetr_nm')))
distances_df <-  dplyr::bind_cols(x, distances_df) |>
dplyr::relocate(any_of(c('Site', 'Allotment')), .before = geometry) |>
dplyr::select(-any_of(c('ID')))
return(distances_df)
}
site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,] |>
sf::st_transform(5070)
sites_in <- sf::st_transform(x, 5070)
azimuth <- round(nngeo::st_azimuth(sites, sites_in), 0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, sites_in, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
place <- data.frame('Place' =
sf::st_drop_geometry(gnis_places[nf, 'fetr_nm']))
distances_df <- data.frame(
Distance = distance_miles,
Azimuth = azimuth,
Place = place
) # |>
#  dplyr::mutate(Site = if_else(
#    Distance < 100, paste0(fetr_nm, '.'),
#    paste0(Distance, 'mi', ' at ', format_degree(Azimuth), ' from ', fetr_nm, '.')),
#    Site = stringr::str_replace(Site, '\\..$', '.')) |>
#  dplyr::select(-any_of(c('Distance', 'Azimuth', 'Place', 'ID', 'fetr_nm')))
#  distances_df <-  dplyr::bind_cols(x, distances_df) |>
#    dplyr::relocate(any_of(c('Site', 'Allotment')), .before = geometry) |>
#    dplyr::select(-any_of(c('ID')))
return(distances_df)
}
site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,] |>
sf::st_transform(5070)
sites_in <- sf::st_transform(x, 5070)
azimuth <- round(nngeo::st_azimuth(sites, sites_in), 0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, sites_in, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
place <- data.frame('Place' =
sf::st_drop_geometry(gnis_places[nf, 'fetr_nm']))
distances_df <- data.frame(
Distance = distance_miles,
Azimuth = azimuth,
Place = place
)  |>
dplyr::mutate(Site = if_else(
Distance < 0.25, paste0(fetr_nm, '.'),
paste0(Distance, 'mi', ' at ', format_degree(Azimuth), ' from ', fetr_nm, '.')),
Site = stringr::str_replace(Site, '\\..$', '.')) |>
dplyr::select(-any_of(c('Distance', 'Azimuth', 'Place', 'ID', 'fetr_nm')))
#  distances_df <-  dplyr::bind_cols(x, distances_df) |>
#    dplyr::relocate(any_of(c('Site', 'Allotment')), .before = geometry) |>
#    dplyr::select(-any_of(c('ID')))
return(distances_df)
}
site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
geodata_writer(sites_in)
geodata_writer(sites_in, path = '.')
filename <- paste0('Collections-', Sys.Date)
filename <- paste0('Collections-', Sys.Date)
filename <- paste0('Collections-', Sys.Date)
Sys.Date
filename <- paste0('Collections-', Sys.Date())
#' write out spatial data for collections to Google earth or QGIS
#'
#' This function will write out a simple labeled shapefile containing just collection number. More data (e.g. species) can be written out using sf::st_write directly.
#' @params x a dataframe which has at least undergone the 'dms2dd' and 'coords2sf' functions from BL
#' @params path a location to save the data to. If not supplied defaults to the current working directory.
#' @params filename, name of file. if not supplied defaults to appending todays date to 'Collections'
#' @params filetype a file format to save the data to. This is a wrapper for sf::st_write and will support all drivers used there. If not supplied defaults to kml for use with google earth.
geodata_writer <- function(x, path, filename, filetype){
if(missing(filetype)){filetype <- 'kml'}
if(missing(filename)){filename <- paste0('Collections-', Sys.Date())}
if(missing(path)){fname <- paste0(filename, filetype)} else {
fname <- file.path(path, paste0(filename, '.', filetype))
}
ifelse(!dir.exists(file.path(path)),
dir.create(file.path(path)), FALSE)
x <- x |>
dplyr::select(Name = Collection_number) |>
sf::st_write(dsn = fname, driver = filetype, delete_dsn = TRUE, quiet = T, append = F)
return(x)
cat('data written to: ', fname)
}
geodata_writer(sites_in, path = '.')
sites_in <- data.frame(
longitude_dd = runif(5, min = -120, max = -100),
latitude_dd = runif(5, min = 35, max = 48),
Collection_number = 1:5
) |>
sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
geodata_writer(sites_in, path = '.')
site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
?azimuth
??azimuth
install.packages('geosphere')
bearingRhumb(sites_in[1:3,], sites_in[3:5,])
geosphere::bearingRhumb(sites_in[1:3,], sites_in[3:5,])
sites_in[1:3,]
st_coordinates(sites_in)
sf::st_coordinates(sites_in)
geosphere::bearingRhumb(
sf::st_coordinates(sites_in[1:3,]), sf::st_coordinates(sites_in[1:3,])
)
sf::st_coordinates(sites_in)
m <- sf::st_coordinates(sites_in)
View(m)
bearingRhumb(c(10,10),c(20,20))
geosphere::bearingRhumb(c(10,10),c(20,20))
geosphere::bearingRhumb(
sf::st_coordinates(sites_in[1:3,]), sf::st_coordinates(sites_in[2:4,])
)
#'  longitude_dd = runif(15, min = -120, max = -100),
#'  latitude_dd = runif(15, min = 35, max = 48)
#'  ) |>
#'  sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
#'
#' head(sites)
#' distaze_results <- distAZE(sites, path = '/hdd/Barneby_Lives-dev/geodata/places') # takes some time
#' head(distaze_results)
#' }
#' @export
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,]
azimuth <- round(
geosphere::bearingRhumb(
sf::st_coordinates(sites), sf::st_coordinates(x)
)
0)
#'  longitude_dd = runif(15, min = -120, max = -100),
#'  latitude_dd = runif(15, min = 35, max = 48)
#'  ) |>
#'  sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
#'
#' head(sites)
#' distaze_results <- distAZE(sites, path = '/hdd/Barneby_Lives-dev/geodata/places') # takes some time
#' head(distaze_results)
#' }
#' @export
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,]
azimuth <- round(
geosphere::bearingRhumb(
sf::st_coordinates(sites), sf::st_coordinates(x)
)
0)
#'  longitude_dd = runif(15, min = -120, max = -100),
#'  latitude_dd = runif(15, min = 35, max = 48)
#'  ) |>
#'  sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
#'
#' head(sites)
#' distaze_results <- distAZE(sites, path = '/hdd/Barneby_Lives-dev/geodata/places') # takes some time
#' head(distaze_results)
#' }
#' @export
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,]
azimuth <- round(
geosphere::bearingRhumb(
sf::st_coordinates(sites), sf::st_coordinates(x)
),
0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, sites_in, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
place <- data.frame('Place' =
sf::st_drop_geometry(gnis_places[nf, 'fetr_nm']))
distances_df <- data.frame(
Distance = distance_miles,
Azimuth = azimuth,
Place = place
)  |>
dplyr::mutate(Site = if_else(
Distance < 0.25, paste0(fetr_nm, '.'),
paste0(Distance, 'mi', ' at ', format_degree(Azimuth), ' from ', fetr_nm, '.')),
Site = stringr::str_replace(Site, '\\..$', '.')) |>
dplyr::select(-any_of(c('Distance', 'Azimuth', 'Place', 'ID', 'fetr_nm')))
distances_df <-  dplyr::bind_cols(x, distances_df) |>
dplyr::relocate(any_of(c('Site', 'Allotment')), .before = geometry) |>
dplyr::select(-any_of(c('ID')))
return(distances_df)
}
test_out <- site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
#'  longitude_dd = runif(15, min = -120, max = -100),
#'  latitude_dd = runif(15, min = 35, max = 48)
#'  ) |>
#'  sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
#'
#' head(sites)
#' distaze_results <- distAZE(sites, path = '/hdd/Barneby_Lives-dev/geodata/places') # takes some time
#' head(distaze_results)
#' }
#' @export
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,]
azimuth <- round(
geosphere::bearingRhumb(
sf::st_coordinates(sites), sf::st_coordinates(x)
),
0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, x, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
place <- data.frame('Place' =
sf::st_drop_geometry(gnis_places[nf, 'fetr_nm']))
distances_df <- data.frame(
Distance = distance_miles,
Azimuth = azimuth,
Place = place
)  |>
dplyr::mutate(Site = if_else(
Distance < 0.25, paste0(fetr_nm, '.'),
paste0(Distance, 'mi', ' at ', format_degree(Azimuth), ' from ', fetr_nm, '.')),
Site = stringr::str_replace(Site, '\\..$', '.')) |>
dplyr::select(-any_of(c('Distance', 'Azimuth', 'Place', 'ID', 'fetr_nm')))
distances_df <-  dplyr::bind_cols(x, distances_df) |>
dplyr::relocate(any_of(c('Site', 'Allotment')), .before = geometry) |>
dplyr::select(-any_of(c('ID')))
return(distances_df)
}
geodata_writer(sites_in, path = '.')
test_out <- site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
#'  longitude_dd = runif(15, min = -120, max = -100),
#'  latitude_dd = runif(15, min = 35, max = 48)
#'  ) |>
#'  sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
#'
#' head(sites)
#' distaze_results <- distAZE(sites, path = '/hdd/Barneby_Lives-dev/geodata/places') # takes some time
#' head(distaze_results)
#' }
#' @export
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,]
azimuth <- round(
geosphere::bearingRhumb(
sf::st_coordinates(sites), sf::st_coordinates(x)
),
0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, x, by_element = T, 'Euclidean')
/ 1609.34, 1
)
)
place <- data.frame('Place' =
sf::st_drop_geometry(gnis_places[nf, 'fetr_nm']))
distances_df <- data.frame(
Distance = distance_miles,
Azimuth = azimuth,
Place = place
)  |>
dplyr::mutate(Site = if_else(
Distance < 0.25, paste0(fetr_nm, '.'),
paste0(Distance, 'mi', ' at ', format_degree(Azimuth), ' from ', fetr_nm, '.')),
Site = stringr::str_replace(Site, '\\..$', '.')) |>
dplyr::select(-any_of(c('Distance', 'Azimuth', 'Place', 'ID', 'fetr_nm')))
distances_df <-  dplyr::bind_cols(x, distances_df) |>
dplyr::relocate(any_of(c('Site', 'Allotment')), .before = geometry) |>
dplyr::select(-any_of(c('ID')))
return(distances_df)
}
#'  longitude_dd = runif(15, min = -120, max = -100),
#'  latitude_dd = runif(15, min = 35, max = 48)
#'  ) |>
#'  sf::st_as_sf(coords = c('longitude_dd', 'latitude_dd'), crs = 4326)
#'
#' head(sites)
#' distaze_results <- distAZE(sites, path = '/hdd/Barneby_Lives-dev/geodata/places') # takes some time
#' head(distaze_results)
#' }
#' @export
site_writer <- function(x, path){
gnis_places <- sf::st_read( file.path(path, 'places/places.shp'), quiet = T)
nf <- sf::st_nearest_feature(x, gnis_places) # identify the row of the nearest GNIS feature
sites <- gnis_places[nf,]
azimuth <- round(
geosphere::bearingRhumb(
sf::st_coordinates(sites), sf::st_coordinates(x)
),
0)
distance_miles <- as.numeric(
round(
sf::st_distance(sites, x, by_element = T)
/ 1609.34, 1
)
)
place <- data.frame('Place' =
sf::st_drop_geometry(gnis_places[nf, 'fetr_nm']))
distances_df <- data.frame(
Distance = distance_miles,
Azimuth = azimuth,
Place = place
)  |>
dplyr::mutate(Site = if_else(
Distance < 0.25, paste0(fetr_nm, '.'),
paste0(Distance, 'mi', ' at ', format_degree(Azimuth), ' from ', fetr_nm, '.')),
Site = stringr::str_replace(Site, '\\..$', '.')) |>
dplyr::select(-any_of(c('Distance', 'Azimuth', 'Place', 'ID', 'fetr_nm')))
distances_df <-  dplyr::bind_cols(x, distances_df) |>
dplyr::relocate(any_of(c('Site', 'Allotment')), .before = geometry) |>
dplyr::select(-any_of(c('ID')))
return(distances_df)
}
test_out <- site_writer(sites_in, path = '/media/steppe/hdd/Barneby_Lives-dev/geodata')
View(test_out)
geodata_writer(sites_in, path = '.')
gc()
devtools::install_github('sagesteppe/BarnebyLives')
